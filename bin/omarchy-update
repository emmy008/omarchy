#!/bin/bash

# Exit immediately if a command exits with a non-zero status
set -e

# Show logo
clear
cat <~/.local/share/omarchy/logo.txt

# Get the latest while trying to preserve any modifications
omarchy_path=~/.local/share/omarchy
git -C $omarchy_path pull --autostash
git -C $omarchy_path diff --check || git -C $omarchy_path reset --merge

# Run migrations
"$HOME/.local/share/omarchy/bin/omarchy-migrate"

# Update system packages
echo -e "\e[32m\nUpdate system packages\e[0m"
sudo apt update && sudo apt upgrade -y

# Also update snap packages if installed
if command -v snap &>/dev/null; then
  sudo snap refresh
fi

# Offer to reboot if the kernel has been changed
CURRENT_KERNEL=$(uname -r)
LATEST_KERNEL=$(dpkg -l | grep "^ii  linux-image-[0-9]" | awk '{print $2}' | sed 's/linux-image-//' | sort -V | tail -n1)

if [ "$CURRENT_KERNEL" != "$LATEST_KERNEL" ]; then
  gum confirm "Linux kernel has been updated from $CURRENT_KERNEL to $LATEST_KERNEL. Reboot?" && sudo reboot now
fi