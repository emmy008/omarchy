#!/bin/bash

# Set recorder based on GPU

[[ -f ~/.config/user-dirs.dirs ]] && source ~/.config/user-dirs.dirs
OUTPUT_DIR="${OMARCHY_SCREENRECORD_DIR:-${XDG_VIDEOS_DIR:-$HOME/Videos}}"

if [[ ! -d "$OUTPUT_DIR" ]]; then
  notify-send "Screen recording directory does not exist: $OUTPUT_DIR" -u critical -t 3000
  exit 1
fi

screenrecording() {
  filename="$OUTPUT_DIR/screenrecording-$(date +'%Y-%m-%d_%H-%M-%S').mp4"
  notify-send "Screen recording starting..." -t 1000
  sleep 1

  # Try to use wf-recorder if available (user may have built it from source)
  # Otherwise use OBS Studio (which requires GUI setup)
  if command -v wf-recorder &>/dev/null; then
    wf-recorder -f "$filename" -c libx264 -p crf=23 -p preset=medium -p movflags=+faststart "$@"
  elif command -v obs &>/dev/null; then
    notify-send "Screen recording" "Please use OBS Studio GUI for screen recording" -u critical
    obs &
    exit 0
  else
    notify-send "No screen recorder found" "Install OBS Studio or build wf-recorder from source" -u critical
    exit 1
  fi
}

if pgrep -x wf-recorder >/dev/null; then
  pkill -x wf-recorder
  notify-send "Screen recording saved to $OUTPUT_DIR" -t 2000
elif [[ "$1" == "output" ]]; then
  screenrecording
else
  region=$(slurp) || exit 1
  screenrecording -g "$region"
fi
